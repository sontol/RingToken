<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Transfer Out</title>
  <meta name="generator" content="Google Web Designer 1.6.1.0620">
  <meta name="template" content="Expandable 2.3.2">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style type="text/css" id="gwd-lightbox-style">
    .gwd-lightbox {
      overflow: hidden;
    }
  </style>
  <style type="text/css" id="gwd-text-style">
    p {
      margin: 0px;
    }
    h1 {
      margin: 0px;
    }
    h2 {
      margin: 0px;
    }
    h3 {
      margin: 0px;
    }
  </style>
  <style type="text/css">
    html, body {
      width: 100%;
      height: 100%;
      margin: 0px;
    }
    .gwd-page-container {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .gwd-page-content {
      transform: perspective(1400px) matrix3d(1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1);
      transform-style: preserve-3d;
      position: absolute;
      background-color: transparent;
    }
    .gwd-page-wrapper {
      position: absolute;
      transform: translateZ(0px);
      background-color: rgb(255, 255, 255);
    }
    .page1-content {
      width: 550px;
      height: 400px;
    }
    .gwd-p-128w {
      position: absolute;
      width: 550px;
      height: 82px;
      left: 0px;
      top: 0px;
      font-family: 'Times New Roman';
      color: rgb(0, 0, 0);
      font-size: 32px;
      font-weight: bold;
      background-image: none;
      background-color: rgb(28, 177, 15);
    }
    .gwd-span-13tm {
      font-family: 'Arial Black';
      left: 0px;
      top: 0px;
    }
    .gwd-p-6dxz {
      position: absolute;
      width: 88px;
      height: 34px;
      font-family: 'Arial Black';
      font-weight: bold;
      color: rgb(0, 0, 0);
      text-align: center;
      left: 1px;
      top: 357px;
      background-image: none;
      background-color: rgb(28, 177, 15);
    }
    .gwd-form-lk8o {
      position: absolute;
      transform-style: preserve-3d;
      width: 550px;
      height: 270px;
      transform-origin: 275px 135px 0px;
      left: 1px;
      top: 82px;
    }
    .gwd-input-mj35 {
      position: absolute;
      transform-origin: 106.5px 18px 0px;
      transform-style: preserve-3d;
      width: 209px;
      height: 30px;
      left: 20px;
      top: 61px;
    }
    .gwd-p-1y0g {
      position: absolute;
      font-family: 'Times New Roman';
      color: rgb(0, 0, 0);
      left: 6px;
      top: 137px;
      height: 24px;
      width: 189px;
      transform-origin: 239.203px 12px 0px;
    }
    .gwd-p-13n4 {
      left: 20px;
      top: 11px;
    }
    .gwd-p-1joo {
      font-family: 'Arial Black';
      font-size: 12px;
    }
    .gwd-p-v9zh {
      transform-style: preserve-3d;
      width: 32px;
      height: 24px;
      font-family: 'Arial Black';
      font-size: 12px;
      left: 9px;
      top: 232px;
    }
    .gwd-input-1fuv {
      position: absolute;
      width: 36px;
      height: 30px;
      left: 289px;
      top: 20px;
    }
    .gwd-input-guha {
      transform-origin: 20px 18px 0px;
    }
    .gwd-input-c0zu {
      left: 353px;
      top: 20px;
    }
    .gwd-input-qwoq {
      transform-style: preserve-3d;
      width: 36px;
      height: 30px;
      left: 419px;
      top: 20px;
    }
    .gwd-input-5zxz {
      transform-style: preserve-3d;
      width: 36px;
      height: 30px;
      left: 301px;
      top: 56px;
    }
    .gwd-input-1p95 {
      transform-origin: center 50% 0px;
      left: 499px;
      top: 58px;
    }
    .gwd-input-1ykf {
      transform-origin: center 50% 0px;
      left: 365px;
      top: 56px;
    }
    .gwd-input-tuwm {
      left: 301px;
      top: 56px;
    }
    .gwd-input-1yvi {
      left: 431px;
      top: 56px;
    }
    .gwd-span-16jp {
      position: absolute;
      font-weight: bold;
      text-align: left;
      color: rgb(0, 0, 0);
      font-size: 20px;
      font-family: 'Arial Black';
      transform-style: preserve-3d;
      left: 301px;
      top: 13px;
      width: 69px;
      height: 22px;
      transform-origin: 47.2969px 14.85px 0px;
    }
    .gwd-p-1oif {
      position: absolute;
      color: rgb(0, 0, 0);
      font-family: Arial;
      transform-origin: 15px 15px 0px;
      transform-style: preserve-3d;
      width: 30px;
      height: 30px;
      left: 315px;
      top: 92px;
    }
    .gwd-p-1ley {
      text-align: center;
      left: 375px;
      top: 91px;
    }
    .gwd-p-mc9w {
      position: absolute;
      font-family: 'Times New Roman';
      color: rgb(0, 0, 0);
      transform-style: preserve-3d;
      left: 174px;
      top: 41px;
      width: 10px;
      height: 18px;
      transform-origin: center 50% 0px;
    }
    .gwd-p-1gh8 {
      transform-style: preserve-3d;
      left: 315px;
      top: 92px;
      width: 30px;
      height: 30px;
      text-align: center;
    }
    .gwd-p-1aor {
      text-align: center;
      transform-style: preserve-3d;
      left: 317px;
      top: 92px;
      width: 30px;
      height: 30px;
    }
    .gwd-p-1vio {
      left: 438px;
      top: 91px;
    }
    .gwd-p-yzx7 {
      left: 375px;
      top: 91px;
    }
    .gwd-p-1fwk {
      left: 315px;
      top: 92px;
    }
    .gwd-p-1brr {
      left: 507px;
      top: 91px;
    }
  </style>
  <link href="gwdpage_style.css" data-version="8" data-exports-type="gwd-page" rel="stylesheet">
  <link href="gwdpagedeck_style.css" data-version="8" data-exports-type="gwd-pagedeck" rel="stylesheet">
  <script data-source="googbase_min.js" data-version="3" data-exports-type="googbase" type="text/javascript" src="googbase_min.js"></script>
  <script data-source="gwd_webcomponents_min.js" data-version="5" data-exports-type="gwd_webcomponents" type="text/javascript" src="gwd_webcomponents_min.js"></script>
  <script data-source="gwdpage_min.js" data-version="8" data-exports-type="gwd-page" type="text/javascript" src="gwdpage_min.js"></script>
  <script data-source="gwdpagedeck_min.js" data-version="8" data-exports-type="gwd-pagedeck" type="text/javascript" src="gwdpagedeck_min.js"></script>
</head>

<body class="document-body">
  <div is="gwd-pagedeck" class="gwd-page-container" id="pagedeck">
    <div is="gwd-page" id="page1" class="gwd-page-wrapper page1-content gwd-lightbox" data-gwd-width="550px" data-gwd-height="400px">
      <div class="gwd-page-content page1-content">
        <p class="gwd-p-128w" id="title"><span class="gwd-span-13tm">Mix</span><br>
          
        </p><br>
        
        <p class="gwd-p-6dxz" id="submit" onclick="mint()">Mix</p>
        <form class="gwd-form-lk8o" id="form1">
          <input class="gwd-input-mj35" id="Ethaddr">
          <p class="gwd-p-1y0g gwd-p-13n4 gwd-p-1joo">Ether Account Address</p>
          <input class="gwd-input-1fuv gwd-input-tuwm">
          <input type="radio" name="mixin" class="gwd-input-1fuv gwd-input-guha gwd-input-5zxz" id="mixin_1">
          <input type="radio" name="mixin" class="gwd-input-1fuv gwd-input-guha gwd-input-c0zu gwd-input-1ykf" checked="true" id="mixin_2">
          <input type="radio" name="mixin" class="gwd-input-1fuv gwd-input-guha gwd-input-c0zu gwd-input-qwoq gwd-input-1yvi" id="mixin_3">
          <input type="radio" name="mixin" class="gwd-input-1fuv gwd-input-guha gwd-input-c0zu gwd-input-qwoq gwd-input-1p95" id="mixin_4">
          <span title="Higher mixin means higher privacy, at the cost of higher tx fee, mixin=1 implies no privacy at all" class="gwd-span-16jp">Mixin</span>
          <p class="gwd-p-1oif gwd-p-1fwk">1</p>
          <p class="gwd-p-1oif gwd-p-1ley gwd-p-yzx7">2</p>
          <p class="gwd-p-1oif gwd-p-1ley gwd-p-1vio">3</p>
          <p class="gwd-p-1oif gwd-p-1ley gwd-p-1vio gwd-p-1brr">4</p>
        </form>
      </div>
    </div>
  </div>
  <script type="text/javascript" id="gwd-init-code">
    (function() {
      document.body.style.opacity = "0";
      var pageDeck = document.getElementById('pagedeck');
      /**
       * Handles the DOMContentLoaded event. The DOMContentLoaded event is
       * fired when the document has been completely loaded and parsed.
       */

      function handleDomContentLoaded(event) {}

      /**
       * Handles the WebComponentsReady event. This event is fired when all
       * custom elements have been registered and upgraded.
       */
      function handleWebComponentsReady(event) {
        document.body.style.opacity = "";
        setTimeout(function() {
          pageDeck.goToPage(pageDeck.getDefaultPage().id);
        }, 0);
      }



      window.addEventListener('DOMContentLoaded',
        handleDomContentLoaded, false);
      window.addEventListener('WebComponentsReady',
        handleWebComponentsReady, false);
      require('nw.gui').Window.get().showDevTools()

    })();
  </script>
  <script type="text/javascript">
    var abi = [{
      "constant": false,
      "inputs": [{
        "name": "Ix",
        "type": "uint256"
      }, {
        "name": "Iy",
        "type": "uint256"
      }],
      "name": "getBalance",
      "outputs": [{
        "name": "",
        "type": "uint256"
      }],
      "type": "function"
    }, {
      "constant": false,
      "inputs": [{
        "name": "pubkey",
        "type": "uint256[2]"
      }, {
        "name": "ecdhkey",
        "type": "uint256[2]"
      }],
      "name": "Mint",
      "outputs": [{
        "name": "",
        "type": "bool"
      }],
      "type": "function"
    }, {
      "constant": false,
      "inputs": [{
        "name": "Ix",
        "type": "uint256"
      }, {
        "name": "Iy",
        "type": "uint256"
      }, {
        "name": "Px",
        "type": "uint256[]"
      }, {
        "name": "Py",
        "type": "uint256[]"
      }, {
        "name": "cs",
        "type": "uint256[]"
      }, {
        "name": "rs",
        "type": "uint256[]"
      }, {
        "name": "Pubkeydestx",
        "type": "uint256"
      }, {
        "name": "Pubkeydesty",
        "type": "uint256"
      }, {
        "name": "ecdhx",
        "type": "uint256"
      }, {
        "name": "ecdhy",
        "type": "uint256"
      }],
      "name": "Mix",
      "outputs": [{
        "name": "",
        "type": "bool"
      }],
      "type": "function"
    }, {
      "anonymous": false,
      "inputs": [{
        "indexed": false,
        "name": "function_name",
        "type": "bytes32"
      }, {
        "indexed": false,
        "name": "from",
        "type": "address"
      }, {
        "indexed": false,
        "name": "errcode",
        "type": "uint256"
      }],
      "name": "Error",
      "type": "event"
    }, {
      "anonymous": false,
      "inputs": [{
        "indexed": false,
        "name": "x",
        "type": "uint256"
      }, {
        "indexed": false,
        "name": "y",
        "type": "uint256"
      }, {
        "indexed": false,
        "name": "ecdhx",
        "type": "uint256"
      }, {
        "indexed": false,
        "name": "ecdhy",
        "type": "uint256"
      }],
      "name": "Deposited",
      "type": "event"
    }];


    var Web3 = require('web3');
    var web3 = new Web3();
    web3.setProvider(new web3.providers.HttpProvider('http://127.0.0.1:8545'));
    var RingToken = web3.eth.contract(abi);
    var RingTokenInstance = RingToken.at('0x6734cf69ea2b0c925aad6e02774dadea4a8897d6');
    var Deposited = RingTokenInstance.Deposited();
    var privkey_end;
    var pubkey_end;
    try {
      var levelup = require('level');

      var pubkey_db = levelup('./pubkeys');
      var privkey_db = levelup('./privkeys');
      pubkey_db.get('end', function(err, value) {
        if (err) {
          if (err.notFound) {
            pubkey_db.put('end', web3.toHex(0));
            pubkey_end = web3.toHex(0);
          }
          // I/O or other error, pass it up the callback chain
          else {
            alert(err);
            return;
          }
        } else {
          pubkey_end = value;
        }
      });
      privkey_db.get('end', function(err, value) {
        if (err) {
          if (err.notFound) {
            privkey_db.put('end', web3.toHex(0));
            privkey_end = web3.toHex(0);
          }
          // I/O or other error, pass it up the callback chain
          else {
            alert(err);
            return;
          }
        } else {
          privkey_end = value;
        }
      });
    } catch (err) {
      alert(err);
    }
    Deposited.watch(function(error, result) {
      if (!error) {
        console.log(result);
        pubkey_db.put(pubkey_end, web3.toHex(result.args.x) + web3.toHex(result.args.y));
        pubkey_end = web3.toHex(web3.toBigNumber(pubkey_end).add(web3.toBigNumber("0x1")));
        pubkey_db.put('end', pubkey_end);


        if (existsSync('./keychain.txt') == true) {
          try {
            var ringsignature = require('./ringsignature');
            var fs = require('fs');
            var inputfilestring = fs.readFileSync('./keychain.txt', 'utf8');
            var aString = inputfilestring.substring(66 * 0 + 2, 66 * 0 + 66);
            var AxString = inputfilestring.substring(66 * 1 + 2, 66 * 1 + 66);
            var AyString = inputfilestring.substring(66 * 2 + 2, 66 * 2 + 66);
            var bString = inputfilestring.substring(66 * 3 + 2, 66 * 3 + 66);
            var BxString = inputfilestring.substring(66 * 4 + 2, 66 * 4 + 66);
            var ByString = inputfilestring.substring(66 * 5 + 2, 66 * 5 + 66);
            var PxString = String("0000000000000000000000000000000000000000000000000000000000000000" + web3.toHex(result.args.x).substring(2)).slice(-64);
            var PyString = String("0000000000000000000000000000000000000000000000000000000000000000" + web3.toHex(result.args.y).substring(2)).slice(-64);
            var RxString = String("0000000000000000000000000000000000000000000000000000000000000000" + web3.toHex(result.args.ecdhx).substring(2)).slice(-64);
            var RyString = String("0000000000000000000000000000000000000000000000000000000000000000" + web3.toHex(result.args.ecdhy).substring(2)).slice(-64);
            console.log(RxString.length);
            var privkey = ringsignature.is_our_pubkey(PxString, PyString, RxString, RyString, aString, AxString, AyString, bString, BxString, ByString);
            if (privkey != "") {
              privkey_db.put(privkey_end, privkey);
              privkey_end = web3.toHex(web3.toBigNumber(privkey_end).add(web3.toBigNumber("0x1")));
              privkey_db.put('end', privkey_end);
            }
          } catch (err) {
            alert(err);
          }
        }
      }
    });

    function EnableTextBox() {
      document.getElementById("Ax").disabled = false;
      document.getElementById("Ay").disabled = false;
      document.getElementById("Bx").disabled = false;
      document.getElementById("By").disabled = false;
    }

    function DisableTextBox() {
      document.getElementById("Ax").disabled = true;
      document.getElementById("Ay").disabled = true;
      document.getElementById("Bx").disabled = true;
      document.getElementById("By").disabled = true;
    }
    var address;

    function mint() {
      var fs = require('fs');
      var ringsignature = require('./ringsignature');

      if (existsSync('./keychain.txt') == false) {
        var keys = ringsignature.create_keychain();
        fs.writeFileSync('./keychain.txt', keys);
      }

      try {
        // INSERT  eth address check here
        address = document.getElementById("Ethaddr").value;
        if (address.substring(0, 2) == "0x" || address.substring(0, 2) == "0X")
          address = address.substring(2);
      } catch (err) {
        alert(err);
      }
     
      var mixin;
      if (document.getElementById("mixin_1").checked == true) {
        mixin = 1;
      } else if (document.getElementById("mixin_2").checked == true) {
        mixin = 2;
      } else if (document.getElementById("mixin_3").checked == true) {
        mixin = 3;
      } else if (document.getElementById("mixin_4").checked == true) {
        mixin = 4;
      }
      var Pubkeystr = "";
      createPubkey(Pubkeystr, mixin, mixin);
    }

    function existsSync(filename) {
      try {
        var fs = require('fs');
        fs.accessSync(filename);
        return true;
      } catch (ex) {
        return false;
      }
    }

    function createPubkey(Pubkeystr, mixin, original_mixin) {
      const crypto = require('crypto');
      var BigNumber = require('bignumber.js');

      var i;
      //TODO: What if not enough pubkey in data base?
      if ((mixin - 1) != 0) {
        //TODO: How to ensure that no two pubkeys are the same?
        var buf = crypto.randomBytes(4);
        var index = new BigNumber(buf.readUInt32LE());
        index = index.mod(web3.toBigNumber(pubkey_end));
        console.log(web3.toHex(index));
        pubkey_db.get(web3.toHex(index), function(error, value) {
          if (error) {
            if (error.notFound) {
              alert("not found");
            } else {
              alert(error);

            }
            return;
          } else {
            var xy = value.split("0x");
            Pubkeystr = Pubkeystr + String("0000000000000000000000000000000000000000000000000000000000000000" + xy[1]).slice(-64);
            Pubkeystr = Pubkeystr + String("0000000000000000000000000000000000000000000000000000000000000000" + xy[2]).slice(-64);

            createPubkey(Pubkeystr, mixin - 1, original_mixin);
          }

        });
      } else {
        fetchPrivkey(Pubkeystr, original_mixin, 0);

      }



    }

    function fetchPrivkey(Pubkeystr, original_mixin, delta) {

      //TODO: cross check with Blockchain on whether privkey already spent and don't increase otherwise
      var Privkeystr = "";
      var ringsignature = require('./ringsignature');
      var BigNumber = require('bignumber.js');
      privkey_db.get('start', function(err, value) {
        var privkey_start;
        if (err) {
          if (err.notFound) {
            privkey_db.put('start', web3.toHex(0));
            privkey_start = web3.toHex(0);
            fetchPrivkey(Pubkeystr, original_mixin);
          }
          // I/O or other error, pass it up the callback chain
          else {
            alert(err);
            return;
          }
        } else {

          privkey_start = web3.toHex(web3.toBigNumber(value).add(web3.toBigNumber(delta)));
          privkey_db.get(privkey_start, function(err, value) {
            if (err) {
              if (err.notFound) {
                alert("privkey not found");
              }
              // I/O or other error, pass it up the callback chain
              else {
                alert(err);
                return;
              }
            } else {
              Privkeystr = String("0000000000000000000000000000000000000000000000000000000000000000" + value.substring(2)).slice(-64);
              // var start = web3.toBigNumber(privkey_start);
              //TODO don't check block chain balance before selecting/incrementing privatekey just in case it hasn't been spent (will need API in the contract)
              //start = start.add(web3.toBigNumber("0x1"));
              //privkey_db.put('start', web3.toHex(start));
              var hasBalance = new BigNumber(0);

              //REPLACE this with 0 and eth address

              var Pubkeydestx = String("0000000000000000000000000000000000000000000000000000000000000000" + address).slice(-64);
              var Pubkeydesty = String("0000000000000000000000000000000000000000000000000000000000000000");
              console.log(Pubkeystr);
              //alert("here");

              try {
                var Signature = ringsignature.create_ring_signature(original_mixin, Privkeystr, Pubkeystr, Pubkeydestx, Pubkeydesty);
              } catch (err) {
                alert(err);
              }
              var Px = [];
              var Py = [];
              var cs = [];
              var rs = [];
              var i = 0;
              var Ix = web3.toBigNumber(Signature.substring(0, 66));
              var Iy = web3.toBigNumber(Signature.substring(66, 132));
              RingTokenInstance.getBalance.call(Ix, Iy, function(err, hasBalance) {
                if (hasBalance.isZero()) {
                  for (i = 0; i < original_mixin; i++) {
                    Px.push(web3.toBigNumber(Signature.substring(66 * (i + 2), 66 * (i + 3))));
                  }
                  for (i = original_mixin; i < 2 * original_mixin; i++) {
                    Py.push(web3.toBigNumber(Signature.substring(66 * (i + 2), 66 * (i + 3))));
                  }
                  for (i = 2 * original_mixin; i < 3 * original_mixin; i++) {
                    rs.push(web3.toBigNumber(Signature.substring(66 * (i + 2), 66 * (i + 3))));
                  }
                  for (i = 3 * original_mixin; i < 4 * original_mixin; i++) {
                    cs.push(web3.toBigNumber(Signature.substring(66 * (i + 2), 66 * (i + 3))));
                  }

                  console.log(Signature);
                  Pubkeydestx = "0x" + Pubkeydestx;
                  Pubkeydesty = "0x" + Pubkeydesty;
                  var Pdestx = web3.toBigNumber(Pubkeydestx);
                  var Pdesty = web3.toBigNumber(Pubkeydesty);
                  var ecdhx = web3.toBigNumber(0);
                  var ecdhy = web3.toBigNumber(0);
                  try {
                    RingTokenInstance.Mix(Ix, Iy, Px, Py, cs, rs, Pdestx, Pdesty, ecdhx, ecdhy, {
                      from: web3.eth.accounts[0],
                      to: RingTokenInstance.address,
                      gas: 3000000
                    });
                  } catch (err) {
                    alert(err);
                  }
                  privkey_db.put('start', privkey_start);
                } else {
                  delta += 1;
                  fetchPrivkey(Pubkeystr, original_mixin, delta);
                }



              });
            }
          });
        }

      });


    }
  </script>
</body>

</html>